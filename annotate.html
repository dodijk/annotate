{% set title = "Annotate" %}
{% extends "template.html" %}
{% macro rating(content, show_content=True) -%}
<div class="rating unrated">
  {% if show_content %}{{ content.content }}{% endif %}
  <input type="hidden" name="content_id" value="{{ content.key.urlsafe() }}" />
    {% for star in range(NUMBER_OF_STARS) %}
        <span class="star"></span>
    {% endfor %}
</div>
{%- endmacro %}
{% block container %}
      <h1>Annotate</h1>
      <p class="lead">Listen to the following piece of audio and rate it.</p>
        
      <div class="row">
        <form method="post">
          <div class="well col-md-8 col-md-offset-2 text-center">
            <div>{{ content.content }}</div>
            
            {% if not subcontents %}
                {{ rating(content, show_content=False) }}
            {% endif %}            
            {% for subcontent in subcontents %}
                {{ rating(subcontent) }}
            {% endfor %}                      
          </div>        
        </form>
      </div>
      
{% endblock %}
{% block script %}
<script type="text/javascript">
$( document ).ready(function() {
    // Handle clicks on stars
    $("form .rating span.star").click(function() {
        var stars = {{ NUMBER_OF_STARS }}-$(this).index();
        var rating = $(this).closest(".rating");
        rate(rating, stars);
    });
    
    function rate(rating, stars) {
        rating.removeClass("unrated");
        rating.fadeOut();
        var form = rating.closest("form");
        form.append('<input type="hidden" name="stars" value="'+stars+'" />');
        if(form.find(".unrated").length == 0)
            form.submit();
    }
    
    // Handle keypresses
    $(document).keypress(function(event) {
		if(event.charCode == 48 && {{ NUMBER_OF_STARS }} > 9) {
			return rate($("form .unrated:first"), 10);
		}
        if(event.charCode < 49) return;
        if(event.charCode > 48+Math.max(9,{{ NUMBER_OF_STARS }})) return;
        var stars = event.charCode-48;
        rate($("form .unrated:first"), stars);
    });
});
</script>

{% endblock %}